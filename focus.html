<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Focus Mode حرفه‌ای با تشخیص مطالعه واقعی - EduPlanner</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.6.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>
<style>
body{font-family: Vazirmatn,sans-serif;}
</style>
</head>
<body class="bg-gray-950 text-gray-100 flex flex-col min-h-screen">

<main class="flex-1 flex flex-col items-center justify-center p-6">

<div class="w-full max-w-3xl bg-gray-900 border border-gray-800 rounded-2xl p-6 text-center shadow-lg">

<h1 class="text-2xl font-bold text-purple-400 mb-4">Focus Mode پیشرفته</h1>

<!-- فرم ایجاد جلسه -->
<div id="sessionForm" class="mb-6 text-left text-gray-300 space-y-3">
<label>مبحث درس</label>
<input id="sessionTitle" type="text" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-gray-100" placeholder="مثلاً: ریاضی فصل ۳">

<div class="flex flex-wrap gap-3">
<div class="text-center">
<label class="text-sm text-gray-400 block mb-1">مدت مطالعه (دقیقه)</label>
<input id="studyMinutes" type="number" min="1" value="25" class="w-28 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-gray-100 text-center">
</div>
<div class="text-center">
<label class="text-sm text-gray-400 block mb-1">مدت استراحت (دقیقه)</label>
<input id="breakMinutes" type="number" min="1" value="5" class="w-28 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-gray-100 text-center">
</div>
<div class="text-center">
<label class="text-sm text-gray-400 block mb-1">چرخه‌ها</label>
<input id="cycles" type="number" min="1" value="4" class="w-28 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-gray-100 text-center">
</div>
</div>

<label class="block mt-3">بارگذاری فایل درس</label>
<input type="file" id="lessonFile" accept=".txt,.pdf" class="text-gray-200">
<div id="fileContent" class="bg-gray-800 text-gray-100 p-3 rounded-lg max-h-64 overflow-auto mt-2"></div>

<div class="mt-4 flex gap-3">
<button id="startBtn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold">شروع جلسه</button>
<a href="/index.html"><button id="backBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-800 rounded-lg font-semibold">بازگشت به داشبورد</button></a>
</div>
</div>

<!-- Focus Mode -->
<div id="focusMode" class="hidden w-full max-w-3xl bg-gray-900 border border-gray-800 rounded-2xl p-6 text-center shadow-lg">

<div id="modeLabel" class="text-sm text-gray-400 mb-2">حالت: آماده</div>
<div id="timer" class="text-5xl font-bold text-white mb-2">25:00</div>
<div id="progressBar" class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
<div id="progressFill" class="h-full bg-purple-600 w-0"></div>
</div>
<div class="text-sm text-gray-300 mt-2">وقفه‌ها: <span id="pausesCount">۰</span></div>
<div class="text-sm text-gray-300">زمان مفید مطالعه: <span id="activeTime">۰:۰۰</span></div>

<div class="flex flex-wrap gap-3 justify-center mt-4">
<button id="pauseBtn" class="px-6 py-2 bg-gray-700 hover:bg-gray-800 rounded-lg font-semibold text-gray-200">توقف</button>
<button id="stopBtn" class="px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-semibold">پایان جلسه</button>
<button id="fullscreenBtn" class="px-6 py-2 bg-gray-700 hover:bg-gray-800 rounded-lg font-semibold">تمام صفحه</button>
<button id="downloadCsvBtn" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">دانلود CSV</button>
</div>

<div class="mt-4 text-yellow-400 text-sm" id="notice"></div>
<video id="camera" width="200" height="150" autoplay muted class="mt-4 rounded-lg border border-gray-700"></video>

</div>

</main>

<script>
// ==== عناصر ====
const sessionTitleInput = document.getElementById('sessionTitle');
const studyMinutesInput = document.getElementById('studyMinutes');
const breakMinutesInput = document.getElementById('breakMinutes');
const cyclesInput = document.getElementById('cycles');
const fileInput = document.getElementById('lessonFile');
const fileContentDiv = document.getElementById('fileContent');

const sessionForm = document.getElementById('sessionForm');
const focusMode = document.getElementById('focusMode');

const timerDisplay = document.getElementById('timer');
const modeLabel = document.getElementById('modeLabel');
const pausesCountEl = document.getElementById('pausesCount');
const activeTimeEl = document.getElementById('activeTime');
const notice = document.getElementById('notice');
const camera = document.getElementById('camera');

const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const stopBtn = document.getElementById('stopBtn');
const downloadCsvBtn = document.getElementById('downloadCsvBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const backBtn = document.getElementById('backBtn');

let studyMinutes=25, breakMinutes=5, totalCycles=1;
let remainingSeconds, initialSeconds, currentCycle=1;
let isRunning=false, isPaused=false, currentMode='study';
let pausesCount=0, actualStudySeconds=0, timerInterval=null;
let sessions=[];

// اعلان ساده
function notify(text){ notice.textContent=text; setTimeout(()=> notice.textContent='',3000); }

// فرمت زمان
function formatTime(s){ const m=Math.floor(s/60); const sec=s%60; return `${m}:${sec.toString().padStart(2,'0')}`; }

// بروزرسانی نمایش
function updateDisplay(){
timerDisplay.textContent=formatTime(remainingSeconds);
modeLabel.textContent=`حالت: ${currentMode==='study'?'مطالعه':'استراحت'} — چرخه ${currentCycle}/${totalCycles}`;
pausesCountEl.textContent=pausesCount;
activeTimeEl.textContent=formatTime(actualStudySeconds);
const pct = 1 - (remainingSeconds/initialSeconds);
document.getElementById('progressFill').style.width=`${Math.min(100,Math.round(pct*100))}%`;
}

// Fullscreen
fullscreenBtn.addEventListener('click',()=>{
const el=document.documentElement;
if(!document.fullscreenElement) el.requestFullscreen();
else document.exitFullscreen();
});

// بارگذاری فایل درس
fileInput.addEventListener('change', e=>{
const file = e.target.files[0];
if(!file) return;
const reader = new FileReader();
reader.onload = ()=>{ fileContentDiv.textContent=reader.result; }
reader.readAsText(file);
});

// ==== Camera + Eye & Activity Tracking ====
let model=null;
async function startCamera(){
try{
const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
camera.srcObject=stream;
camera.style.display='block';
model = await faceLandmarksDetection.load(faceLandmarksDetection.SupportedPackages.mediapipeFacemesh);
}catch(e){ console.warn('دوربین فعال نشد',e); }
}

// تشخیص مطالعه واقعی
let lastInteraction = Date.now();
fileContentDiv.addEventListener('scroll',()=>{ lastInteraction=Date.now(); });
fileContentDiv.addEventListener('mousemove',()=>{ lastInteraction=Date.now(); });

async function isStudying(){
if(!model || !isRunning || isPaused) return false;
const predictions = await model.estimateFaces({input:camera});
if(predictions.length===0) return false;
const leftEye = predictions[0].annotations.leftEyeUpper0.concat(predictions[0].annotations.leftEyeLower0);
const rightEye = predictions[0].annotations.rightEyeUpper0.concat(predictions[0].annotations.rightEyeLower0);
function eyeOpen(eye){ let yMax=Math.max(...eye.map(p=>p[1])); let yMin=Math.min(...eye.map(p=>p[1])); return (yMax-yMin)>5; }
const looking = eyeOpen(leftEye) && eyeOpen(rightEye);
const active = (Date.now()-lastInteraction)<5000; // تعامل اخیر با فایل
return looking && active;
}

// ==== تایمر ====
async function startInterval(){
if(timerInterval) return;
timerInterval = setInterval(async()=>{
if(!isRunning || isPaused) return;
remainingSeconds--;
const studying = await isStudying();
if(currentMode==='study' && studying){ actualStudySeconds++; }
else if(currentMode==='study' && !studying){ notify('وقفه: مطالعه واقعی تشخیص داده نشد'); }
if(remainingSeconds<=0){
if(currentMode==='study'){ currentMode='break'; remainingSeconds=breakMinutes*60; initialSeconds=remainingSeconds; notify('زمان مطالعه تمام شد، استراحت آغاز شد'); }
else{ if(currentCycle<totalCycles){ currentCycle++; currentMode='study'; remainingSeconds=studyMinutes*60; initialSeconds=remainingSeconds; notify('استراحت تمام شد، مطالعه آغاز شد'); }
else{ stopSession(true); notify('جلسه تکمیل شد'); } }
}
updateDisplay();
},1000);
}

// ==== کنترل‌ها ====
startBtn.addEventListener('click',()=>{
studyMinutes = parseInt(studyMinutesInput.value)||25;
breakMinutes = parseInt(breakMinutesInput.value)||5;
totalCycles = parseInt(cyclesInput.value)||1;
remainingSeconds=studyMinutes*60; initialSeconds=remainingSeconds;
currentCycle=1; currentMode='study'; pausesCount=0; actualStudySeconds=0;
isRunning=true; isPaused=false;
sessionForm.classList.add('hidden');
focusMode.classList.remove('hidden');
updateDisplay();
startCamera();
startInterval();
notify('جلسه آغاز شد');
});

pauseBtn.addEventListener('click',()=>{ if(!isRunning) return; isPaused=!isPaused; if(isPaused){ pausesCount++; notify('تایمر متوقف شد'); }else{ notify('ادامه تایمر'); } updateDisplay(); });

stopBtn.addEventListener('click',()=>{ stopSession(false); });

backBtn.addEventListener('click',()=>{
focusMode.classList.add('hidden');
sessionForm.classList.remove('hidden');
notify('بازگشت به داشبورد');
});

// پایان جلسه
function stopSession(auto=false){
isRunning=false; clearInterval(timerInterval); timerInterval=null;
sessions.push({
title: sessionTitleInput.value || 'بدون عنوان',
plannedMinutes: studyMinutes,
actualSeconds: actualStudySeconds,
pauses: pausesCount,
cycles: currentCycle,
completed:auto
});
updateDisplay();
notify(auto?'جلسه تکمیل شد':'جلسه متوقف شد');
}

// خروجی CSV
downloadCsvBtn.addEventListener('click',()=>{
if(!sessions.length){ notify('تاریخی وجود ندارد'); return; }
const header = ['title','plannedMinutes','actualSeconds','pauses','cycles','completed'];
const csv = [header.join(',')].concat(sessions.map(r=>header.map(h=>r[h]??'').join(','))).join('\n');
const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
const url = URL.createObjectURL(blob);
const a = document.createElement('a'); a.href=url;
a.download = `sessions_${new Date().toISOString().slice(0,10)}.csv`; a.click();
URL.revokeObjectURL(url);
});
</script>

</body>
</html>
